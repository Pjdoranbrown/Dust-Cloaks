<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dust Cloaks</title>
    <style>
        /* --- CSS STYLES --- */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1815;
            font-family: 'Georgia', 'Times New Roman', serif;
            color: #2a2520;
            user-select: none;
        }
        #gameCanvas {
            display: block;
            image-rendering: pixelated;
        }
        /* HUD Layer */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            color: #fff;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }
        .hud-panel {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #5d4e3e;
            pointer-events: none;
            border-radius: 4px;
        }
        #top-hud {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 8px;
            border: 2px solid #d4af37;
        }
        #luck-container, #hp-container {
            position: relative;
            width: 150px;
            height: 16px;
            background: #222;
            border: 2px solid #555;
        }
        #luck-bar {
            height: 100%;
            width: 0%;
            background: #d4af37;
            transition: width 0.1s;
        }
        #luck-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 0 #000;
            z-index: 2;
        }
        #hp-bar {
            height: 100%;
            width: 100%;
            background: #b22222;
            transition: width 0.1s;
        }
        #xp-bar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: #000;
            z-index: 5;
        }
        #xp-bar {
            height: 100%;
            background: #4169e1;
            width: 0%;
            transition: width 0.2s;
        }
        #formation-indicator {
            position: absolute;
            bottom: 30px;
            left: 30px;
            font-size: 20px;
            color: #fff;
        }
        
        /* Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 10;
        }
        .menu-screen {
            background: url('parchmentFoldedCrinkled.png') no-repeat center center fixed;
            background-size: cover;
            color: #2a2520;
        }
        .menu-screen h1 {
            color: #4a3b2a;
            text-shadow: none;
            font-weight: 900;
            font-size: 64px;
            text-decoration: underline;
            font-variant: small-caps;
            margin-bottom: 20px;
        }
        .menu-screen p, .menu-screen div {
            text-shadow: none;
            color: #2a2520;
            font-weight: 500;
        }
        .overlay-screen {
            background: rgba(0,0,0,0.85); 
            color: #dcdcdc;
        }
        .overlay-screen h1 {
            text-shadow: 2px 2px 0 #000;
            color: #d4af37;
        }
        .hidden { display: none !important; }

        /* Components */
        .btn {
            background: #4a3b2a;
            border: 3px solid #2a2520;
            color: #f0e6d2;
            padding: 15px 40px;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-family: 'Georgia', serif;
            transition: all 0.2s;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.4);
            border-radius: 4px;
        }
        .btn:hover { background: #5d4e3e; color: #fff; transform: scale(1.05); }
        .btn-small { padding: 10px 25px; font-size: 18px; margin: 10px; display: inline-block; }
        .btn-disabled { opacity: 0.5; pointer-events: none; border-color: #555; color: #777; background: #333; }
        
        /* Grids */
        #camp-grid, #roster-grid, #manual-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1100px;
            justify-content: center;
            padding-bottom: 60px;
        }
        #camp-screen, #roster-screen, #char-creation-screen, #manual-screen {
            justify-content: flex-start;
            padding-top: 40px;
            overflow-y: auto;
        }
        
        /* --- NEW GRID FOR RACE SELECTION --- */
        #race-selection-grid, #char-selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 Columns, 2 Rows */
            gap: 20px;
            max-width: 900px;
            justify-items: center;
        }

        /* Split Upgrade Grid */
        #upgrade-grid {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            width: 95%;
            max-width: 1300px;
            margin-top: 20px;
        }
        .upgrade-column {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-content: flex-start;
            gap: 15px;
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            min-height: 400px;
        }
        .column-header {
            width: 100%;
            text-align: center;
            color: #d4af37;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 2px solid #4a3b2a;
            text-transform: uppercase;
            padding-bottom: 5px;
        }

        .camp-section, .manual-section-header {
            width: 100%;
            text-align: center;
            color: #4a3b2a;
            border-bottom: 3px solid #4a3b2a;
            margin: 30px 0 20px 0;
            font-weight: 800;
            font-size: 28px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Cards */
        .upgrade-card {
            background: rgba(245, 235, 215, 0.9);
            border: 2px solid #4a3b2a;
            width: 200px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            position: relative;
            color: #1a1a1a;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        .upgrade-card:hover {
            transform: translateY(-5px);
            background: #fff;
            border-color: #000;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.4);
        }
        .upgrade-card.disabled { opacity: 0.6; pointer-events: none; background: #ccc; }
        .upgrade-card.selected { border-color: #228b22; background: #e0f0e0; border-width: 3px; }
        
        .card-icon { width: 64px; height: 64px; margin-bottom: 10px; image-rendering: pixelated; border: 1px solid #aaa; background: rgba(0,0,0,0.05); border-radius: 4px; }
        .card-title { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 5px; color: #000; }
        .card-role { font-size: 14px; font-style: italic; text-align: center; margin-bottom: 8px; color: #444; font-weight: bold; }
        .card-desc { font-size: 13px; text-align: center; line-height: 1.4; color: #333; }
        
        /* Manual Cards */
        .manual-card {
            background: rgba(245, 235, 215, 0.9);
            border: 2px solid #4a3b2a;
            width: 320px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            color: #2a2520;
            margin-bottom: 10px;
            box-shadow: 3px 3px 6px rgba(0,0,0,0.2);
        }
        .manual-card-header { display: flex; align-items: center; width: 100%; border-bottom: 2px solid #4a3b2a; padding-bottom: 10px; margin-bottom: 10px; }
        .manual-icon { width: 64px; height: 64px; margin-right: 15px; image-rendering: pixelated; border: 2px solid #4a3b2a; background: rgba(255,255,255,0.5); border-radius: 4px; }
        .manual-title { font-size: 22px; font-weight: bold; color: #000; }
        .manual-role { font-size: 15px; font-style: italic; color: #555; }
        .manual-stats { font-size: 15px; width: 100%; margin-bottom: 10px; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; font-weight: bold; }
        .manual-stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dotted #aaa; }
        .manual-desc { font-size: 14px; line-height: 1.5; font-style: italic; color: #333; }
        
        /* Camp Buttons */
        .upgrade-btn {
            background: rgba(245, 235, 215, 0.85);
            border: 2px solid #4a3b2a;
            width: 220px;
            padding: 12px;
            cursor: pointer;
            position: relative;
            text-align: left;
            transition: all 0.2s;
            color: #2a2520;
            font-family: 'Georgia', serif;
            font-weight: bold;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            /* New Flex for Icon */
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .upgrade-btn:hover { background: #fff; border-color: #000; transform: scale(1.02); }
        .upgrade-btn.purchased { background: #d0e0d0; border-color: #228b22; opacity: 0.8; }
        .upgrade-name { font-size: 15px; display: block; }
        .upgrade-cost { font-size: 14px; float: right; color: #8b0000; font-weight: bold; }
        .upgrade-btn.purchased .upgrade-cost { color: #228b22; }
        
        .upgrade-btn-icon {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .upgrade-desc {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 220px;
            background: #fff;
            border: 2px solid #000;
            padding: 10px;
            z-index: 100;
            font-size: 13px;
            color: #000;
            pointer-events: none;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
        }
        .upgrade-btn:hover .upgrade-desc { display: block; }

        /* Misc */
        .damage-text { position: absolute; font-weight: 900; pointer-events: none; animation: floatUp 0.8s forwards; font-size: 20px; text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-40px) scale(1.2); } }
        
        #tutorial { position: absolute; top: 70px; left: 30px; color: #fff; font-size: 16px; text-shadow: 1px 1px 2px #000; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 4px; }
        #gold-display { font-size: 28px; color: #4a3b2a; margin-top: 10px; font-weight: 900; text-shadow: 1px 1px 0px #fff; }
        #creation-steps { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .creation-step { display: none; width: 100%; align-items: center; flex-direction: column; }
        .creation-step.active { display: flex; }
        #name-input-container { display: flex; gap: 10px; margin-top: 20px; }
        #char-name-input { padding: 10px; font-size: 24px; background: rgba(255, 255, 255, 0.8); color: #000; border: 2px solid #4a3b2a; font-family: inherit; font-weight: bold; width: 300px; text-align: center; }

        /* Camp Visuals on Start Screen */
        #camp-visuals {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 200px;
            pointer-events: none;
            z-index: 1; 
        }
        .camp-building {
            position: absolute;
            bottom: 0;
            transform: translateX(-50%);
            image-rendering: pixelated;
            width: 64px; 
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <!-- UI Overlay -->
    <div id="ui-layer" class="hidden">
        <div id="xp-bar-container"><div id="xp-bar"></div></div>
        
        <div id="top-hud" class="hud-panel">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <span style="font-size:10px; color:#ddd;">CONDITION</span>
                <div id="hp-container"><div id="hp-bar"></div></div>
            </div>
            <div style="display:flex; flex-direction:column; align-items:center;">
                <span style="font-size:10px; color:#ddd;">LUCK (PRESS Q)</span>
                <div id="luck-container">
                    <div id="luck-bar"></div>
                    <div id="luck-text">0 / 10</div>
                </div>
            </div>
            <div>
                <span style="font-size:10px; color:#ddd;">TIME</span><br>
                <span id="timer" style="font-size:20px;">00:00</span>
            </div>
            <div>
                <span style="font-size:10px; color:#ddd;">SQUAD</span><br>
                <span id="squad-count" style="font-size:20px;">1/6</span>
            </div>
            <div>
                <span style="font-size:10px; color:#ddd;">LEVEL</span><br>
                <span id="level-display" style="font-size:20px;">1</span>
            </div>
            <div>
                <span style="font-size:10px; color:#ddd;">GOLD</span><br>
                <span id="gold-hud" style="font-size:20px; color: gold;">0</span>
            </div>
        </div>

        <div id="formation-indicator" class="hud-panel">
            TACTIC: <span id="tactic-name" style="color:#d4af37">WEDGE</span> <span style="font-size:12px; color:#aaa;">[SPACE]</span>
        </div>

        <div id="tutorial">
            WASD: Move<br>
            SPACE: Toggle Formation (Requires Lvl 3 Soldier)<br>
            Q: Burn Luck (Ultimate)
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen menu-screen">
        <h1>Dust Cloaks</h1>
        <div id="gold-display">Gold: 0</div>
        
        <div style="margin-top: 30px; display: flex; gap: 20px;">
            <button class="btn" onclick="startCreation()">RECRUIT SQUAD LEADER</button>
        </div>
        
        <div style="margin-top: 15px;">
            <button class="btn btn-small" onclick="openRoster()">ROSTER</button>
            <button class="btn btn-small" onclick="openCamp()">CAMP UPGRADES</button>
            <button class="btn btn-small" onclick="openManual()">PLAYER'S MANUAL</button>
        </div>

        <!-- VISUALS CONTAINER -->
        <div id="camp-visuals"></div>
    </div>
    
    <!-- Character Creation Screen -->
    <div id="char-creation-screen" class="screen menu-screen hidden">
        <h1 id="creation-title">Select Race</h1>
        <div id="creation-steps">
            <div id="step-race" class="creation-step active"><div id="race-selection-grid"></div></div>
            <div id="step-class" class="creation-step"><div id="char-selection-grid"></div></div>
            <div id="step-name" class="creation-step">
                <p style="font-size:24px; font-weight:bold;">Identity Confirmation</p>
                <div id="name-input-container">
                    <input type="text" id="char-name-input" placeholder="Enter Name">
                    <button class="btn btn-small" onclick="randomizeName()">Randomize</button>
                </div>
                <button class="btn" onclick="finalizeCreation()">SIGN CONTRACT</button>
            </div>
        </div>
        <button class="btn btn-small" style="margin-top: 20px;" onclick="closeCreation()">CANCEL</button>
    </div>

    <!-- Roster Screen -->
    <div id="roster-screen" class="screen menu-screen hidden">
        <h1>Active Roster</h1>
        <button class="btn btn-small" onclick="closeRoster()">BACK</button>
        <div id="roster-grid"></div>
    </div>
    
    <!-- Camp Screen -->
    <div id="camp-screen" class="screen menu-screen hidden">
        <h1>Camp Upgrades</h1>
        <div id="camp-gold" style="color:#8b0000; font-size:24px; margin-bottom:10px; font-weight:bold;">Gold: 0</div>
        <button class="btn btn-small" onclick="closeCamp()">BACK TO CONTRACTS</button>
        <div id="camp-grid"></div>
    </div>

    <!-- Manual Screen -->
    <div id="manual-screen" class="screen menu-screen hidden">
        <h1>Player's Manual</h1>
        <button class="btn btn-small" onclick="closeManual()">BACK TO MENU</button>
        <div id="manual-content"></div>
    </div>

    <!-- Level Up Screen (In-Game Overlay) -->
    <div id="levelup-screen" class="screen overlay-screen hidden">
        <h1 style="font-size: 32px;">RECRUITMENT</h1>
        <p style="color:#aaa;">Upgrade Squad or Recruit New</p>
        <div id="upgrade-grid"></div>
    </div>

    <!-- Game Over Screen (In-Game Overlay) -->
    <div id="gameover-screen" class="screen overlay-screen hidden">
        <h1 style="color: #b22222;">SQUAD BROKEN</h1>
        <p id="death-stats" style="color:#aaa;">You survived for 00:00</p>
        <button id="resurrect-btn" class="btn" style="border-color: #4169e1; color: #4169e1;" onclick="resurrectLeader()">RESURRECT LEADER (10g)</button>
        <button class="btn" onclick="location.reload()">RETURN TO GUILD</button>
    </div>

    <!-- Win Screen (In-Game Overlay) -->
    <div id="win-screen" class="screen overlay-screen hidden">
        <h1 style="color: #4169e1;">CONTRACT COMPLETE</h1>
        <p style="color:#aaa;">The area is secure.</p>
        <button class="btn" onclick="location.reload()">COLLECT PAYMENT</button>
    </div>

<script>
/**
 * DUST CLOAKS: SURVIVOR PROTOTYPE
 * Refactored for Stability
 */

// ==========================================
// 1. DATA DEFINITIONS & CONFIGURATION
// ==========================================

const CONFIG = {
    PLAYER_SPEED_WEDGE: 3.5,
    PLAYER_SPEED_SHIELD: 2.0,
    SQUAD_FOLLOW_SPEED: 0.1, 
    ENEMY_SPAWN_RATE: 25, 
    XP_BASE_REQ: 10,
    XP_SCALING: 1.5,
    MAX_TOTAL_SQUAD_SIZE: 12,
    SQUAD_SIZE_PER_LEADER: 6,
    SECOND_LEADER_COST: 20,
    BASE_PICKUP_RADIUS: 100
};

const RACES = {
    ELVES: { name: "Elf", moveSpeed: 1.10, hp: -15, desc: "A race as diverse as the realms they inhabit. Fleet of foot but fragile.", statsText: "Movement Speed: +10% | Max HP: -15" },
    GREENSKINS: { name: "Green Skin", moveSpeed: 0.95, dmgMult: 1.10, hp: 15, desc: "Fierce orcs, cunning goblins, and brutal hobgoblins. Tough survivors who hit hard.", statsText: "Max HP: +15 | Damage: +10% | Speed: -5%" },
    HUMAN: { name: "Human", dmgFlat: 5, hp: 5, moveSpeed: 1.05, luck: -3, desc: "Ambitious and adaptable. Good at everything, but cursed by fate.", statsText: "All Stats: +3 (Approx) | Luck: -3" },
    MUDDLED: { name: "Muddled", dmgFlat: 2, hp: 2, moveSpeed: 1.05, luck: 2, desc: "Those of mixed heritage who straddle the line between worlds.", statsText: "All Stats: +1 | Luck: +2" },
    OUTSIDER: { name: "Outsider", cooldownMult: 0.85, hp: -20, desc: "Born of infernal or divine unions. Channel power quickly but unstable forms.", statsText: "Attack Speed: +15% | Max HP: -20" },
    SHORTFOLK: { name: "Short Folk", dmgMult: 1.05, moveSpeed: 0.95, luck: 5, desc: "Dwarves, gnomes, and halflings. Stout and lucky.", statsText: "Luck: +5 | Damage: +5% | Speed: -5%" }
};

const NAMES = {
    ELVES: ["Aelrindel", "Faenor", "Lyra", "Thalia", "Silaqui", "Erendil"],
    GREENSKINS: ["Grok", "Mog", "Snagga", "Kruel", "Boz", "Griznut"],
    HUMAN: ["Baldric", "Osric", "Edith", "Wulf", "Godfrey", "Rowan"],
    MUDDLED: ["Half-Jack", "Mix", "Cross", "Blur", "Twain", "Mingle"],
    OUTSIDER: ["Xol", "Vex", "Null", "Void", "Entropy", "Kaos"],
    SHORTFOLK: ["Bramble", "Took", "Pip", "Knub", "Shorty", "Fumble"]
};

const CLASS_DEFS = {
    SOLDIER: { name: 'Soldier', role: 'Vanguard', color: '#404040', desc: 'Melee sweep. Lvl 3 unlocks Shield Wall formation.', range: 60, cooldown: 60, damage: 18, imgKey: 'SOLDIER' },
    SCOUNDREL: { name: 'Scoundrel', role: 'DPS', color: '#1a1a1a', desc: 'Single Target Stab. Lvl 3 drops slowing traps.', range: 40, cooldown: 40, damage: 35, imgKey: 'SCOUNDREL' },
    MAGE: { name: 'Mage', role: 'Artillery', color: '#00008b', desc: 'Fast projectiles. Lvl 3 summons Fireball Zones.', range: 400, cooldown: 35, damage: 12, imgKey: 'MAGE' },
    CLERIC: { name: 'Cleric', role: 'Support', color: '#b8860b', desc: 'AoE Knockback. Lvl 3 heals squad every 10s.', range: 80, cooldown: 80, damage: 12, imgKey: 'CLERIC' },
    WITCH: { name: 'Witch', role: 'Debuffer', color: '#4b0082', desc: 'Permanent Poison DoT. Lvl 3 Fears enemies.', range: 250, cooldown: 70, damage: 3, imgKey: 'WITCH' },
    FOLK_HERO: { name: 'Folk Hero', role: 'Control', color: '#006400', desc: 'Directional shot. Lvl 3 increases XP collection.', range: 300, cooldown: 50, damage: 14, imgKey: 'FOLK_HERO' }
};

const ENEMY_DEFS = {
    RAT: { name: 'Rat', hp: 15, speed: 0.8, damage: 3, xp: 5, imgKey: 'RAT', color: '#654321', scale: 2.0 },
    BAT: { name: 'Bat', hp: 10, speed: 2.0, damage: 4, xp: 8, imgKey: 'BAT', color: '#333333', scale: 2.0 },
    OGRE: { name: 'Ogre', hp: 120, speed: 0.6, damage: 15, xp: 30, imgKey: 'OGRE', color: '#2e8b57', scale: 3.5 },
    CRAB: { name: 'Crab', hp: 50, speed: 2.5, damage: 12, xp: 20, imgKey: 'CRAB', color: '#cd5c5c', scale: 2.5 }
};

const UPGRADES = [
    { category: "Camp Followers", id: "brothel", name: "Brothel", desc: "Max Luck +2", cost: 50, imgKey: 'BROTHEL', x: 15 },
    { category: "Camp Followers", id: "kitchen", name: "Kitchen", desc: "Max HP +20", cost: 50, imgKey: 'FIRE', x: 20 },
    { category: "Camp Followers", id: "housing", name: "Housing", desc: "HP Regen +0.5/sec", cost: 100, imgKey: 'HOUSE', x: 25 },
    { category: "Command", id: "command", name: "Command Tent", desc: "Attack Cooldowns -5%", cost: 300, imgKey: 'TENT', x: 55 },
    { category: "Command", id: "guildhall", name: "Guild Hall", desc: "Start at Level 2", cost: 500 },
    { category: "Magical", id: "alchemy", name: "Alchemy Lab", desc: "Witch Damage +25%", cost: 150, imgKey: 'ALCHEMY', x: 85 },
    { category: "Magical", id: "magetower", name: "Mage Tower", desc: "Mage Damage +25%", cost: 150, imgKey: 'MAGE_TOWER', x: 95 },
    { category: "Medical", id: "hospital", name: "Field Hospital", desc: "Heal 20 HP on Level Up", cost: 100 },
    { category: "Medical", id: "herbalist", name: "Herbalist", desc: "Pickup Range +20%", cost: 75, imgKey: 'PINES', x: 90 },
    { category: "Economy", id: "merchant", name: "Merchant Stalls", desc: "Gold Drop Rate +5%", cost: 200 },
    { category: "Economy", id: "cells", name: "Prisoner Cells", desc: "XP Gain +10%", cost: 100, imgKey: 'WALL', x: 10 },
    { category: "Class Specific", id: "ranger", name: "Ranger's Hut", desc: "Folk Hero Damage +25%", cost: 150, imgKey: 'RANGER', x: 75 },
    { category: "Class Specific", id: "chapel", name: "Chapel", desc: "Cleric Damage +25%", cost: 150, imgKey: 'CHAPEL', x: 35 },
    { category: "Class Specific", id: "church", name: "Church", desc: "Max HP +50", cost: 250, imgKey: 'CHURCH', x: 45 },
    { category: "Class Specific", id: "pens", name: "Slave Pens", desc: "Scoundrel Damage +25%", cost: 150, imgKey: 'PENS', x: 5 },
    { category: "Storage", id: "armory", name: "Armory", desc: "Soldier Damage +25%", cost: 150, imgKey: 'TOWER_WATCH', x: 60 },
    { category: "Storage", id: "stables", name: "Stables", desc: "Move Speed +10%", cost: 100, imgKey: 'STABLE', x: 65 },
    { category: "Training", id: "grounds", name: "Training Grounds", desc: "XP Gain +20%", cost: 200, imgKey: 'FENCE', x: 50 },
    { category: "Workshops", id: "blacksmith", name: "Blacksmith Forge", desc: "Global Damage +10%", cost: 300 },
    { category: "Workshops", id: "carpentry", name: "Carpentry Shop", desc: "Projectile Speed +20%", cost: 100 },
    { category: "Workshops", id: "engineering", name: "Engineering", desc: "Effect Duration +20%", cost: 150 },
    { category: "Workshops", id: "leather", name: "Leatherworking", desc: "Damage Reduction +1", cost: 200 },
];

// ==========================================
// 2. STATE & ENGINE VARIABLES
// ==========================================

const SAVE_KEY = 'dust_cloaks_v3';
let META = { gold: 0, upgrades: {}, roster: [] };
let canvas, ctx;
let ASSETS = {};

// Game State
let GAME = {
    state: 'START', width: 0, height: 0, frames: 0, time: 0, score: 0,
    level: 1, xp: 0, xpReq: CONFIG.XP_BASE_REQ,
    formation: 'WEDGE', luck: 0, maxLuck: 20, luckBurnCount: 0,
    hp: 100, maxHp: 100, canUseShieldWall: false
};
let creationData = { race: null, classKey: null, name: "" };
let currentRunStats = { kills: 0, gold: 0 };
let keys = { w:false, a:false, s:false, d:false, space:false, q:false };

// Entities Lists
let player;
let squad = [];
let enemies = [];
let pickups = [];
let projectiles = [];
let floatingTexts = [];

// ==========================================
// 3. PERSISTENCE & UTILS
// ==========================================


function getRandomName(raceKey) {
    const list = NAMES[raceKey] || NAMES.HUMAN;
    return list[Math.floor(Math.random() * list.length)];
}

function addFloatingText(x, y, text, color) {
    floatingTexts.push({ x, y, text, color, life: 30 });
}

function checkCollision(c1, c2) {
    const dx = c1.x - c2.x;
    const dy = c1.y - c2.y;
    return Math.hypot(dx, dy) < c1.radius + c2.radius;
}

function getNearestEnemy(x, y, range) {
    let nearest = null;
    let minDst = range;
    for (const e of enemies) {
        const dst = Math.hypot(e.x - x, e.y - y);
        if (dst < minDst) { minDst = dst; nearest = e; }
    }
    return nearest;
}

function loadAssets() {
    const sources = {
        SOLDIER: 'tile_0087.png', MAGE: 'tile_0084.png', CLERIC: 'tile_0098.png',
        SCOUNDREL: 'tile_0100.png', WITCH: 'tile_0111.png', FOLK_HERO: 'tile_0112.png',
        BACKGROUND: 'battlfield_tileset.png',
        RAT: 'tile_0123.png', BAT: 'tile_0120.png', OGRE: 'tile_0109.png', CRAB: 'tile_0110.png',
        // Camp Buildings
        TENT: 'tent.png', STABLE: 'stable.png', HOUSE: 'house.png',
        BROTHEL: 'houseChimney.png', ALCHEMY: 'runis.png', MAGE_TOWER: 'towerTall.png',
        CHAPEL: 'church.png', CHURCH: 'churchLarge.png', PENS: 'dock.png', RANGER: 'houseSmall.png',
        // New Buildings
        TOWER_WATCH: 'towerWatch.png', FENCE: 'fence.png', WALL: 'wall.png', 
        PINES: 'treePinesSmall.png', FIRE: 'campfire.png'
    };
    for(let key in sources) {
        const img = new Image();
        img.src = sources[key];
        ASSETS[key] = img;
    }
}

// ==========================================
// 4. GAME ENTITIES (CLASSES)
// ==========================================

class Entity {
    constructor(x, y, radius, color) {
        this.x = x; this.y = y; this.radius = radius; this.color = color;
        this.markedForDeletion = false;
    }
    draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
        ctx.closePath();
    }
}

class SquadMate extends Entity {
    constructor(type, index, raceKey = 'HUMAN', name = 'Grunt') {
        super(0, 0, 10, CLASS_DEFS[type].color);
        this.type = type;
        this.race = raceKey;
        this.name = name;
        this.stats = { ...CLASS_DEFS[type] };
        this.cooldownTimer = 0;
        this.specialTimer = 0; 
        this.index = index; 
        this.level = META.upgrades['guildhall'] ? 2 : 1; 
        this.applyUpgrades();
        this.applyRaceStats();
    }

    applyRaceStats() {
        const r = RACES[this.race];
        if (r) {
            if (r.dmgMult) this.stats.damage = Math.ceil(this.stats.damage * r.dmgMult);
            if (r.dmgFlat) this.stats.damage += r.dmgFlat;
            if (r.cooldownMult) this.stats.cooldown = Math.ceil(this.stats.cooldown * r.cooldownMult);
        }
    }

    applyUpgrades() {
        if (META.upgrades['blacksmith']) this.stats.damage = Math.ceil(this.stats.damage * 1.1);
        if (META.upgrades['command']) this.stats.cooldown = Math.ceil(this.stats.cooldown * 0.95);
        let dmgMult = 1.0;
        if (this.type === 'WITCH' && META.upgrades['alchemy']) dmgMult = 1.25;
        if (this.type === 'MAGE' && META.upgrades['magetower']) dmgMult = 1.25;
        if (this.type === 'FOLK_HERO' && META.upgrades['ranger']) dmgMult = 1.25;
        if (this.type === 'CLERIC' && META.upgrades['chapel']) dmgMult = 1.25;
        if (this.type === 'SCOUNDREL' && META.upgrades['pens']) dmgMult = 1.25;
        if (this.type === 'SOLDIER' && META.upgrades['armory']) dmgMult = 1.25;
        this.stats.damage = Math.ceil(this.stats.damage * dmgMult);
    }

    upgrade() {
        this.level++;
        if (this.type === 'CLERIC') {
            this.stats.damage = Math.floor(this.stats.damage * 1.5);
            this.stats.range += 15; 
        } else if (this.type === 'FOLK_HERO') {
            this.stats.damage += 5;
            this.stats.cooldown = Math.max(10, Math.floor(this.stats.cooldown * 0.8)); 
        } else if (this.type === 'MAGE') {
            this.stats.damage += 5;
        } else if (this.type === 'SCOUNDREL') {
            this.stats.damage += 10;
            this.stats.cooldown = Math.max(10, Math.floor(this.stats.cooldown * 0.9));
        } else if (this.type === 'SOLDIER') {
            this.stats.damage += 5;
            this.stats.cooldown = Math.max(10, Math.floor(this.stats.cooldown * 0.9));
        }
        checkSquadSynergies();
        addFloatingText(player.x, player.y, `LVL UP!`, "#4169e1");
    }

    update(leaderX, leaderY, leaderAngle, formation) {
        let targetX, targetY;
        const spacing = 25;
        let commanderX = leaderX;
        let commanderY = leaderY;
        let commanderAngle = leaderAngle;

        if (this.index >= 7) {
            const leader2 = squad[6];
            commanderX = leader2.x;
            commanderY = leader2.y;
        } 
        
        if (this.index === 0) {
            this.x = leaderX; this.y = leaderY;
        } else if (this.index === 6) {
            const trailDist = 80;
            targetX = leaderX - Math.cos(leaderAngle) * trailDist;
            targetY = leaderY - Math.sin(leaderAngle) * trailDist;
            this.x += (targetX - this.x) * (CONFIG.SQUAD_FOLLOW_SPEED * 0.8);
            this.y += (targetY - this.y) * (CONFIG.SQUAD_FOLLOW_SPEED * 0.8);
        } else {
            const localIndex = this.index >= 7 ? this.index - 6 : this.index; 
            if (formation === 'WEDGE') {
                const side = localIndex % 2 === 0 ? 1 : -1;
                const row = Math.ceil(localIndex / 2);
                const offsetX = -row * spacing * 1.5; 
                const offsetY = side * row * spacing; 
                const rotX = offsetX * Math.cos(commanderAngle) - offsetY * Math.sin(commanderAngle);
                const rotY = offsetX * Math.sin(commanderAngle) + offsetY * Math.cos(commanderAngle);
                targetX = commanderX + rotX;
                targetY = commanderY + rotY;
            } else { 
                const totalMates = 5; 
                const angleStep = (Math.PI * 2) / totalMates;
                const angle = (localIndex - 1) * angleStep;
                targetX = commanderX + Math.cos(angle) * spacing;
                targetY = commanderY + Math.sin(angle) * spacing;
            }
            this.x += (targetX - this.x) * CONFIG.SQUAD_FOLLOW_SPEED;
            this.y += (targetY - this.y) * CONFIG.SQUAD_FOLLOW_SPEED;
        }

        if (this.level >= 3) this.handleSpecials();
        if (this.cooldownTimer > 0) this.cooldownTimer--;
        else this.performAttack(leaderAngle);
    }

    handleSpecials() {
        if (this.type === 'CLERIC') {
            this.specialTimer++;
            if (this.specialTimer >= 600) {
                GAME.hp = Math.min(GAME.hp + 15, GAME.maxHp);
                addFloatingText(this.x, this.y - 20, "+SQUAD HEAL", "#gold");
                this.specialTimer = 0;
            }
        } else if (this.type === 'MAGE') {
            this.specialTimer++;
            if (this.specialTimer >= 240) { 
                const fx = this.x + (Math.random() * 300 - 150);
                const fy = this.y + (Math.random() * 300 - 150);
                projectiles.push(new FireballZone(fx, fy));
                this.specialTimer = 0;
            }
        }
    }

    draw() {
        if (this.index === 0) return; 
        const img = ASSETS[this.stats.imgKey];
        if (img && img.complete && img.naturalWidth !== 0) {
            const size = this.radius * 3.0; 
            ctx.drawImage(img, this.x - size/2, this.y - size/2, size, size);
            if (this.index === 6) {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius * 1.5, 0, Math.PI * 2);
                ctx.lineWidth = 2;
                ctx.strokeStyle = "#D4AF37";
                ctx.stroke();
            }
        } else {
            super.draw();
        }
    }

    performAttack(angle) {
        const enemy = getNearestEnemy(this.x, this.y, this.stats.range);
        if (this.type === 'SOLDIER' && enemy) {
            projectiles.push(new MeleeSwipe(this.x, this.y, enemy.x, enemy.y, this.stats.damage));
            this.cooldownTimer = this.stats.cooldown;
        } else if (this.type === 'MAGE' && enemy) {
            projectiles.push(new MagicMissile(this.x, this.y, enemy, this.stats.damage));
            this.cooldownTimer = this.stats.cooldown;
        } else if (this.type === 'SCOUNDREL') {
            if (enemy) {
                projectiles.push(new DaggerMelee(this.x, this.y, enemy.x, enemy.y, this.stats.damage));
                this.cooldownTimer = this.stats.cooldown;
            }
            if (this.level >= 3 && Math.random() > 0.7) projectiles.push(new Trap(this.x, this.y, this.stats.damage));
        } else if (this.type === 'CLERIC' && getNearestEnemy(this.x, this.y, this.stats.range)) {
            projectiles.push(new Shockwave(this.x, this.y, this.stats.range, this.stats.damage));
            this.cooldownTimer = this.stats.cooldown;
        } else if (this.type === 'WITCH' && enemy) {
            projectiles.push(new PoisonBolt(this.x, this.y, enemy, this.stats.damage, this.level >= 3));
            this.cooldownTimer = this.stats.cooldown;
        } else if (this.type === 'FOLK_HERO') {
            projectiles.push(new StraightShot(this.x, this.y, angle, this.stats.damage));
            this.cooldownTimer = this.stats.cooldown;
        }
    }
}

class Enemy extends Entity {
    constructor() {
        const time = GAME.time;
        let typeKey = 'RAT';
        if (time < 30) typeKey = 'RAT';
        else if (time < 60) typeKey = Math.random() > 0.5 ? 'BAT' : 'RAT';
        else if (time < 90) typeKey = Math.random() > 0.2 ? 'BAT' : 'RAT';
        else {
            const rand = Math.random();
            if (rand < 0.1) typeKey = 'RAT'; else if (rand < 0.55) typeKey = 'OGRE'; else typeKey = 'CRAB';
        }
        const stats = ENEMY_DEFS[typeKey];
        const side = Math.floor(Math.random() * 4);
        let x, y;
        const pad = 50;
        if (side === 0) { x = Math.random() * GAME.width; y = -pad; }
        else if (side === 1) { x = GAME.width + pad; y = Math.random() * GAME.height; }
        else if (side === 2) { x = Math.random() * GAME.width; y = GAME.height + pad; }
        else { x = -pad; y = Math.random() * GAME.height; }

        super(x, y, 12, stats.color);
        this.typeStats = stats;
        this.hp = stats.hp + (GAME.level * 3);
        this.maxSpeed = stats.speed * (0.9 + Math.random() * 0.2);
        this.damage = stats.damage;
        this.xp = stats.xp;
        if (typeKey === 'OGRE') this.radius = 20;
        this.poisoned = false; this.poisonDmg = 0; this.fearTimer = 0; this.slowTimer = 0;
    }

    update() {
        if (this.poisoned && GAME.frames % 60 === 0) takeEnemyDamage(this, this.poisonDmg, false);
        if (this.slowTimer > 0) this.slowTimer--;
        if (this.fearTimer > 0) this.fearTimer--;

        let dx = player.x - this.x;
        let dy = player.y - this.y;
        if (this.fearTimer > 0) { const temp = dx; dx = -dy; dy = temp; }

        const dist = Math.hypot(dx, dy);
        let currentSpeed = this.maxSpeed;
        if (this.slowTimer > 0) currentSpeed *= 0.5;

        if (dist > 0) {
            this.x += (dx / dist) * currentSpeed;
            this.y += (dy / dist) * currentSpeed;
        }

        if (checkCollision(this, player)) {
            takePlayerDamage(this.damage);
            this.markedForDeletion = true; 
        }
    }

    draw() {
        const img = ASSETS[this.typeStats.imgKey];
        if (img && img.complete && img.naturalWidth !== 0) {
            const size = this.radius * this.typeStats.scale; 
            ctx.save();
            if (this.poisoned) ctx.filter = 'sepia(1) hue-rotate(50deg)';
            if (this.fearTimer > 0) ctx.filter = 'invert(1)';
            ctx.drawImage(img, this.x - size/2, this.y - size/2, size, size);
            ctx.restore();
        } else {
            super.draw();
        }
    }
}

class XPOrb extends Entity {
    constructor(x, y, val) { super(x, y, 4, '#4169e1'); this.value = val; }
    update() {
        let pickupRange = CONFIG.BASE_PICKUP_RADIUS;
        if (META.upgrades['herbalist']) pickupRange *= 1.2;
        if (squad.some(m => m.type === 'FOLK_HERO' && m.level >= 3)) pickupRange *= 2.5;

        const dist = Math.hypot(player.x - this.x, player.y - this.y);
        if (dist < pickupRange) { 
            this.x += (player.x - this.x) * 0.15;
            this.y += (player.y - this.y) * 0.15;
        }
        if (dist < player.radius + 10) {
            gainXP(this.value);
            this.markedForDeletion = true;
        }
    }
    draw() {
        ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = this.color; ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.stroke();
    }
}

class GoldOrb extends Entity {
    constructor(x, y) { super(x, y, 5, '#ffd700'); }
    update() {
        let pickupRange = CONFIG.BASE_PICKUP_RADIUS;
        const dist = Math.hypot(player.x - this.x, player.y - this.y);
        if (dist < pickupRange) { 
            this.x += (player.x - this.x) * 0.15;
            this.y += (player.y - this.y) * 0.15;
        }
        if (dist < player.radius + 10) {
            currentRunStats.gold += 1;
            META.gold += 1;
            saveGame();
            addFloatingText(this.x, this.y, "+1g", "gold");
            this.markedForDeletion = true;
        }
    }
    draw() {
        ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = "gold"; ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.stroke();
    }
}

// ==========================================
// 5. PROJECTILES
// ==========================================

class Projectile extends Entity {
    constructor(x, y, r, color, damage, duration) {
        super(x, y, r, color);
        this.damage = damage;
        this.duration = META.upgrades['engineering'] ? Math.floor(duration * 1.2) : duration;
    }
    update() {
        this.duration--;
        if (this.duration <= 0) this.markedForDeletion = true;
    }
}

class MagicMissile extends Projectile {
    constructor(x, y, target, damage) {
        super(x, y, 5, '#87CEEB', damage, 60);
        this.target = target;
        this.speed = META.upgrades['carpentry'] ? 8.4 : 7;
    }
    update() {
        super.update();
        if (this.target && !this.target.markedForDeletion) {
            const dx = this.target.x - this.x;
            const dy = this.target.y - this.y;
            const dist = Math.hypot(dx, dy);
            this.x += (dx / dist) * this.speed;
            this.y += (dy / dist) * this.speed;
            if (dist < 10) { takeEnemyDamage(this.target, this.damage); this.markedForDeletion = true; }
        } else { this.markedForDeletion = true; }
    }
}

class FireballZone extends Projectile {
    constructor(x, y) { super(x, y, 60, 'rgba(255, 69, 0, 0.4)', 5, 240); }
    update() {
        super.update();
        if (this.duration % 20 === 0) {
            enemies.forEach(e => { if (Math.hypot(e.x - this.x, e.y - this.y) < this.radius) takeEnemyDamage(e, this.damage, false); });
        }
    }
}

class MeleeSwipe extends Projectile {
    constructor(x, y, tx, ty, damage) {
        super(x, y, 35, 'rgba(200,200,200,0.5)', damage, 8);
        enemies.forEach(e => { if (Math.hypot(e.x - x, e.y - y) < 45) takeEnemyDamage(e, damage, true); });
    }
}

class DaggerMelee extends Projectile {
    constructor(x, y, tx, ty, damage) {
        super(x, y, 10, '#fff', damage, 5);
        const angle = Math.atan2(ty - y, tx - x);
        const hx = x + Math.cos(angle) * 20;
        const hy = y + Math.sin(angle) * 20;
        enemies.forEach(e => { if (Math.hypot(e.x - hx, e.y - hy) < 20) takeEnemyDamage(e, damage); });
    }
}

class Trap extends Projectile {
    constructor(x, y, damage) { super(x, y, 15, '#8B4513', damage, 600); this.active = true; }
    update() {
        if (!this.active) { this.markedForDeletion = true; return; }
        this.duration--;
        if (this.duration <= 0) this.markedForDeletion = true;
        enemies.forEach(e => {
            if (Math.hypot(e.x - this.x, e.y - this.y) < this.radius + e.radius) {
                takeEnemyDamage(e, this.damage);
                e.slowTimer = 180;
                this.active = false;
                addFloatingText(this.x, this.y, "SNAP!", "red");
            }
        });
    }
}

class Shockwave extends Projectile {
    constructor(x, y, range, damage) {
        super(x, y, range, 'rgba(255, 215, 0, 0.3)', damage, 15);
        enemies.forEach(e => {
             if (Math.hypot(e.x - x, e.y - y) < range) {
                 takeEnemyDamage(e, damage, true);
                 const angle = Math.atan2(e.y - y, e.x - x);
                 e.x += Math.cos(angle) * 30; e.y += Math.sin(angle) * 30;
             }
        });
    }
}

class PoisonBolt extends Projectile {
    constructor(x, y, target, damage, causesFear) {
        super(x, y, 6, '#800080', damage, 60);
        this.target = target; this.causesFear = causesFear;
        this.speed = META.upgrades['carpentry'] ? 7.2 : 6;
    }
    update() {
        super.update();
        if (this.target && !this.target.markedForDeletion) {
             const dx = this.target.x - this.x; const dy = this.target.y - this.y;
             const dist = Math.hypot(dx, dy);
             this.x += (dx/dist)*this.speed; this.y += (dy/dist)*this.speed;
             if (dist < 10) {
                 takeEnemyDamage(this.target, this.damage);
                 this.target.poisoned = true; this.target.poisonDmg = 2;
                 if (this.causesFear) this.target.fearTimer = 120;
                 this.markedForDeletion = true;
             }
        } else { this.markedForDeletion = true; }
    }
}

class StraightShot extends Projectile {
    constructor(x, y, angle, damage) {
        super(x, y, 5, '#228B22', damage, 60);
        let speed = META.upgrades['carpentry'] ? 12 : 10;
        this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
    }
    update() {
        super.update();
        this.x += this.vx; this.y += this.vy;
        enemies.forEach(e => {
            if (checkCollision(this, e)) { takeEnemyDamage(e, this.damage); this.markedForDeletion = true; }
        });
    }
}

// ==========================================
// 6. UI & MENU SYSTEMS
// ==========================================

// ==========================================
// 7. GAME LOOP & LOGIC
// ==========================================

// ==========================================
// 8. INITIALIZATION
// ==========================================

</script>
<script src="js/persistence.js"></script>
<script src="js/ui/menus.js"></script>
<script src="js/ui/screens.js"></script>
<script src="js/ui/hud.js"></script>
<script src="js/game/gameplay.js"></script>
<script src="js/game/gameLoop.js"></script>
<script src="js/game/init.js"></script>
</body>
</html>
